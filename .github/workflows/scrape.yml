name: ðŸ”„ FF Events Auto-Scraper

on:
  # Run on schedule (every 6 hours)
  schedule:
    - cron: '0 */6 * * *'
  
  # Allow manual trigger from GitHub UI
  workflow_dispatch:
    inputs:
      region:
        description: 'Specific region to scrape (leave empty for all)'
        required: false
        default: ''
        type: choice
        options:
          - ''
          - pakistan
          - india
          - brazil
          - vietnam
          - indonesia
          - singapore
          - taiwan
          - thailand

jobs:
  scrape:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ðŸŒ Install Chrome & dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            google-chrome-stable \
            fonts-liberation \
            libnss3 \
            libatk-bridge2.0-0 \
            libdrm2 \
            libxkbcommon0 \
            libgbm1 \
            libgtk-3-0 \
            libasound2 \
            libxshmfence1 \
            libx11-xcb1 \
            libxcomposite1 \
            libxdamage1 \
            libxrandr2 \
            libpango-1.0-0 \
            libcairo2 \
            libcups2 \
            libdbus-1-3 \
            libatspi2.0-0 \
            xdg-utils \
            wget \
          || true

      - name: ðŸ“¦ Install dependencies
        run: npm install
        env:
          PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: false

      - name: ðŸ” Verify Chrome
        run: |
          echo "Puppeteer Chrome path:"
          node -e "const p = require('puppeteer'); console.log(p.executablePath());" || echo "Using bundled chrome"
          echo "System Chrome:"
          which google-chrome-stable || echo "No system chrome"

      - name: ðŸ” Scrape All Regions
        if: ${{ github.event.inputs.region == '' || github.event.inputs.region == null }}
        env:
          GOOGLE_SCRIPT_URL: ${{ secrets.GOOGLE_SCRIPT_URL }}
        run: node index.js --once

      - name: ðŸ” Scrape Specific Region
        if: ${{ github.event.inputs.region != '' && github.event.inputs.region != null }}
        env:
          GOOGLE_SCRIPT_URL: ${{ secrets.GOOGLE_SCRIPT_URL }}
        run: node index.js --test --region ${{ github.event.inputs.region }}

      - name: ðŸ“Š Summary
        if: always()
        run: |
          echo "## ðŸ“Š Scrape Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Time**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ github.event.inputs.region }}" ]; then
            echo "- **Region**: ${{ github.event.inputs.region }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Region**: All (8 regions)" >> $GITHUB_STEP_SUMMARY
          fi
